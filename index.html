<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gest√£o de Ensino - CPP II Bauru</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { 
            --verde: #2d9344; --laranja: #e67e22; --azul: #3498db; --roxo: #8b5cf6;
            --vermelho: #d32f2f; --cinza-claro: #f4f7f6; --dark: #2c3e50;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--cinza-claro); display: flex; flex-direction: column; min-height: 100vh; }

        #main-header { text-align: center; padding: 20px 10px; }
        .logo-placeholder { font-size: 3rem; margin-bottom: 5px; display: block; }
        h2 { color: var(--dark); font-size: 1.8rem; text-transform: uppercase; }
        .subtitle { color: #666; font-size: 0.9rem; font-weight: 500; }

        #main-menu { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; width: 95%; max-width: 900px; margin: 10px auto; }
        .card-btn { height: 120px; border: none; border-radius: 12px; color: white; font-weight: bold; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(0,0,0,0.1); transition: 0.3s; }
        .card-btn i { font-size: 2rem; margin-bottom: 10px; }
        .card-btn:hover { transform: translateY(-3px); filter: brightness(1.1); }

        .btn-verde { background: var(--verde); }
        .btn-laranja { background: var(--laranja); }
        .btn-azul { background: var(--azul); }
        .btn-roxo { background: var(--roxo); }

        .content-card { width: 98%; max-width: 1350px; background: white; border-radius: 12px; padding: 20px; display: none; box-shadow: 0 8px 20px rgba(0,0,0,0.1); margin: 15px auto 30px auto; }
        .active { display: flex; flex-direction: column; }
        .btn-voltar { background: #666; color: white; border: none; padding: 8px 15px; border-radius: 6px; font-weight: bold; cursor: pointer; margin-bottom: 15px; align-self: flex-start; }

        .form-row { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; align-items: flex-end; }
        label { display: block; font-size: 0.75rem; font-weight: bold; margin-bottom: 4px; color: var(--dark); }
        input, select, textarea { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.82rem; height: 38px; }
        textarea { height: auto; }
        
        .btn-std { padding: 10px 15px; border-radius: 6px; border: none; font-weight: bold; cursor: pointer; color: white; transition: 0.2s; font-size: 0.85rem; height: 38px; }
        .table-wrapper { width: 100%; max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; margin-top: 10px; }
        table { width: 100%; border-collapse: collapse; }
        thead th { position: sticky; top: 0; background: #f8f9fa; padding: 12px; border-bottom: 2px solid #dee2e6; font-size: 0.75rem; color: var(--dark); }
        tbody td { padding: 10px; border-bottom: 1px solid #eee; text-align: center; font-size: 0.82rem; }

        .btn-icon { border: none; background: none; cursor: pointer; font-size: 1.1rem; padding: 0 5px; }

        #modalGeral, #modalGestaoAlunos { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        
        #loading { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); z-index:5000; justify-content:center; align-items:center; flex-direction:column; }
        footer { text-align: center; padding: 20px; color: #777; font-size: 0.8rem; margin-top: auto; width: 100%; }
        .badge-conc { background: var(--vermelho); color: white; font-size: 0.6rem; padding: 2px 4px; border-radius: 3px; margin-left: 5px; }
    </style>
</head>
<body>

    <div id="loading"><i class="fa fa-spinner fa-spin fa-2x"></i><p style="margin-top:10px; font-weight:bold;">PROCESSANDO...</p></div>

    <div id="main-header">
        <span class="logo-placeholder">üéì</span>
        <h2>Gest√£o de Ensino</h2>
        <div class="subtitle">CPP II "Dr. Eduardo de Oliveira Vianna" de Bauru</div>
    </div>

    <div id="main-menu">
        <button class="card-btn btn-verde" onclick="abrir('cursos')"><i class="fa fa-book-open"></i>Cursos</button>
        <button class="card-btn btn-laranja" onclick="abrir('regular')"><i class="fa fa-school"></i>Ensino Regular</button>
        <button class="card-btn btn-azul" onclick="abrir('superior')"><i class="fa fa-graduation-cap"></i>Ensino Superior</button>
        <button class="card-btn btn-roxo" onclick="abrir('projetos')"><i class="fa fa-folder-open"></i>Projetos / Jornada</button>
    </div>

    <div id="cursos" class="content-card">
        <button class="btn-voltar" onclick="voltarAoMenu()">Menu</button>
        <h3 style="color:var(--verde); margin-bottom:10px;">Cursos Profissionalizantes</h3>
        <div class="form-row">
            <div style="flex:2;"><label>Nome do curso</label><input type="text" id="curNome"></div>
            <div style="width:150px;"><label>Tipo</label><select id="curTipo"><option value="">Selecione...</option><option>Profissionalizante</option><option>PROET</option><option>TELEPORT</option><option>Cultural</option></select></div>
            <div style="width:100px;"><label>Carga hor√°ria</label><input type="text" id="curCarga"></div>
            <div style="width:140px;"><label>Data in√≠cio</label><input type="date" id="curIni"></div>
            <div style="width:100px;"><label>Participantes</label><input type="number" id="curPart"></div>
            <button class="btn-std btn-verde" onclick="salvarNovo('cursos')">Salvar</button>
        </div>
        <div class="table-wrapper"><table><thead><tr><th>N¬∫</th><th>Curso</th><th>Tipo</th><th>Carga</th><th>In√≠cio</th><th>T√©rmino</th><th>Participantes</th><th>Concluintes</th><th>A√ß√µes</th></tr></thead><tbody id="listaCursos"></tbody></table></div>
    </div>

    <div id="superior" class="content-card">
        <button class="btn-voltar" onclick="voltarAoMenu()">Menu</button>
        <h3 style="color:var(--azul); margin-bottom:10px;">Ensino Superior</h3>
        <div class="form-row">
            <div style="flex:2;"><label>Nome do curso</label><input type="text" id="supNome"></div>
            <div style="width:130px;"><label>Grau</label><select id="supGrau"><option>Tecn√≥logo</option><option>Gradua√ß√£o</option><option>P√≥s</option><option>Mestrado</option><option>Doutorado</option></select></div>
            <div style="flex:1;"><label>Institui√ß√£o</label><input type="text" id="supInst"></div>
            <div style="width:120px;"><label>Per√≠odo</label><select id="supPer"><option>Matutino</option><option>Vespertino</option><option>Noturno</option></select></div>
            <div style="width:60px;"><label>Sala</label><input type="text" id="supSala" maxlength="1"></div>
            <div style="width:70px;"><label>Alunos</label><input type="number" id="supAlunos"></div>
            <div style="width:140px;"><label>Data in√≠cio</label><input type="date" id="supIni"></div>
            <button class="btn-std btn-azul" onclick="salvarNovo('superior')">Salvar</button>
        </div>
        <div class="table-wrapper"><table><thead><tr><th>N¬∫</th><th>Curso</th><th>Grau</th><th>Institui√ß√£o</th><th>Per√≠odo</th><th>Sala</th><th>Alunos</th><th>In√≠cio</th><th>T√©rmino</th><th>A√ß√µes</th></tr></thead><tbody id="listaSuperior"></tbody></table></div>
    </div>

    <div id="regular" class="content-card">
        <button class="btn-voltar" onclick="voltarAoMenu()">Menu</button>
        <div style="display:flex; justify-content:space-between; align-items:flex-end; margin-bottom:15px;">
            <h3 style="color:var(--laranja);">Ensino Regular - Grades de Sala</h3>
            <button class="btn-std" style="background:var(--dark);" onclick="abrirGestaoAlunos()"><i class="fa fa-users"></i> Gest√£o de Alunos</button>
        </div>
        <div class="form-row">
            <div style="flex:2.5;"><label>Grade (Nome da sala)</label><input type="text" id="regGrade"></div>
            <div style="width:160px;"><label>Tipo</label><select id="regTipo"><option>Alfabetiza√ß√£o</option><option>Fundamental Final</option><option>Ensino M√©dio</option></select></div>
            <div style="width:125px;"><label>Per√≠odo</label><select id="regPer"><option>Matutino</option><option>Vespertino</option><option>Noturno</option></select></div>
            <div style="width:130px;"><label>Semestre</label><select id="regSem"><option>1¬∫ Semestre</option><option>2¬∫ Semestre</option></select></div>
            <div style="width:70px;"><label>Sala</label><input type="text" id="regSala" maxlength="1"></div>
            <div style="width:130px;"><label>Data in√≠cio</label><input type="date" id="regIni"></div>
            <div style="width:130px;"><label>Data t√©rmino</label><input type="date" id="regFim"></div>
            <button class="btn-std btn-laranja" onclick="salvarNovo('regular')">Salvar</button>
        </div>
        <div class="table-wrapper"><table><thead><tr><th>Grade</th><th>Tipo</th><th>Per√≠odo</th><th>Semestre</th><th>Sala</th><th>Total</th><th>Matriculados</th><th>Exclu√≠dos</th><th>A√ß√µes</th></tr></thead><tbody id="listaSalas"></tbody></table></div>
    </div>

    <div id="modalGestaoAlunos">
        <div class="modal-content" style="width:98%; max-width:1150px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom:2px solid var(--dark); padding-bottom:10px;">
                <h3 style="color:var(--dark)"><i class="fa fa-users-cog"></i> Gest√£o de Alunos</h3>
                <button class="btn-std" style="background:var(--vermelho)" onclick="fecharGestaoAlunos()">Sair</button>
            </div>

            <div style="background:#f4f4f4; padding:12px; border-radius:8px; margin-bottom:15px; border:1px dashed #aaa;">
                <label style="color:var(--verde)">Importar dados em lote (Excel)</label>
                <textarea id="txtExcel" style="height:50px; margin:5px 0; font-size: 0.75rem;" placeholder="Cole as colunas: Matr√≠cula | Nome | Grade | S√©rie"></textarea>
                <button class="btn-std btn-verde" style="padding:5px 15px" onclick="importarExcel()">Processar lote</button>
            </div>

            <div class="form-row" style="background:#eef2f3; padding:15px; border-radius:8px;">
                <div style="width:120px;"><label>Matr√≠cula</label><input type="text" id="alMat"></div>
                <div style="flex:3;"><label>Nome completo</label><input type="text" id="alNome"></div>
                <div style="width:200px;"><label>Sala (Grade)</label><select id="alGrade"></select></div>
                <div style="width:100px;"><label>S√©rie</label><select id="alSerie"><option>1¬∫</option><option>2¬∫</option><option>3¬∫</option><option>4¬∫</option><option>5¬∫</option><option>6¬∫</option><option>7¬∫</option><option>8¬∫</option><option>9¬∫</option></select></div>
                <div style="width:130px;"><label>Data in√≠cio</label><input type="date" id="alIni"></div>
                <button class="btn-std btn-azul" onclick="salvarAlunoManual()">Adicionar</button>
            </div>
            
            <div class="form-row" style="margin-top:10px;">
                <div style="width:100%;"><label>Filtrar Aluno (Busca r√°pida por Nome, Matr√≠cula ou Grade)</label><input type="text" id="filtroAlu" onkeyup="filtrarAlunos()" placeholder="Digite para pesquisar..."></div>
            </div>

            <div class="table-wrapper"><table><thead><tr><th>Matr√≠cula</th><th style="text-align:left">Nome</th><th>Grade</th><th>S√©rie</th><th>In√≠cio</th><th>T√©rmino</th><th>A√ß√µes</th></tr></thead><tbody id="listaAlunos"></tbody></table></div>
        </div>
    </div>

    <div id="modalGeral">
        <div class="modal-content" style="width:450px;">
            <h4 id="mTit" style="border-bottom:2px solid var(--dark); margin-bottom:15px; padding-bottom:5px;">Editar Registro</h4>
            <input type="hidden" id="mIdx"><input type="hidden" id="mTipo">
            <div id="mCampos" style="display:flex; flex-direction:column; gap:10px;"></div>
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="btn-std btn-verde" style="flex:1" onclick="confirmarEdicao()">Confirmar</button>
                <button class="btn-std" style="flex:1; background:#666" onclick="fecharModal()">Sair</button>
            </div>
        </div>
    </div>

    <footer>Idealizado por: <b>Allan Ramos | Policial Penal | CPP II de Bauru</b></footer>

    <script>
        const URL_SCRIPT = "https://script.google.com/macros/s/AKfycbw_uZ8-aSjr0zmU5yfynA4He3oZ0E-hluKw1zg-kJCirAmSUN6xMFlOwwOEJVvBECQ2XQ/exec";
        let db = { cursos: [], superior: [], regular: [], alunos: [] };

        async function abrir(id) {
            document.getElementById('main-menu').style.display = 'none';
            document.getElementById('main-header').style.display = 'none';
            document.querySelectorAll('.content-card').forEach(c => c.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            await carregarDados();
        }

        function voltarAoMenu() {
            document.querySelectorAll('.content-card').forEach(c => c.classList.remove('active'));
            document.getElementById('main-menu').style.display = 'grid';
            document.getElementById('main-header').style.display = 'block';
        }

        async function carregarDados() {
            document.getElementById('loading').style.display = 'flex';
            try {
                const res = await fetch(URL_SCRIPT);
                const data = await res.json();
                // Mapeamento correto das colunas do Google para o Objeto JS
                db.cursos = (data.cursos || []).map(c => ({
                    nome: c.curso || c.nome || "---",
                    tipo: c.tipo || "",
                    carga: c.carga || "",
                    inicio: c.in√≠cio || c.inicio || "",
                    termino: c.t√©rmino || c.termino || "",
                    part: c.part || c.participantes || 0,
                    conc: c.conc || c.concluintes || 0,
                    concluido: c.status === "SIM" || c.concluido === true
                }));
                db.superior = data.superior || [];
                db.regular = (data.salas || []).map(s => ({
                    grade: s.grade || "",
                    tipo: s.tipo || "",
                    per: s.per√≠odo || s.per || "",
                    sem: s.semestre || s.sem || "",
                    sala: s.sala || "",
                    inicio: s.in√≠cio || s.inicio || "",
                    termino: s.t√©rmino || s.termino || ""
                }));
                db.alunos = data.alunos || [];
                
                renderCursos(); renderSuperior(); renderRegular();
            } catch(e) { alert("Erro ao sincronizar dados!"); }
            document.getElementById('loading').style.display = 'none';
        }

        function renderCursos() {
            const tb = document.getElementById('listaCursos'); tb.innerHTML = "";
            db.cursos.forEach((c, i) => {
                tb.innerHTML += `<tr><td>${i+1}</td><td style="text-align:left">${c.nome}${c.concluido?'<span class="badge-conc">CONC</span>':''}</td><td>${c.tipo}</td><td>${c.carga}</td><td>${fmtD(c.inicio)}</td><td>${fmtD(c.termino)}</td><td>${c.part}</td><td>${c.conc}</td>
                <td><button class="btn-icon" style="color:orange" onclick="abrirEdicao('cursos',${i})"><i class="fa fa-edit"></i></button>
                <button class="btn-icon" style="color:red" onclick="removerItem('cursos',${i})"><i class="fa fa-trash"></i></button></td></tr>`;
            });
        }

        function renderSuperior() {
            const tb = document.getElementById('listaSuperior'); tb.innerHTML = "";
            db.superior.forEach((c, i) => {
                tb.innerHTML += `<tr><td>${i+1}</td><td style="text-align:left">${c.nome}</td><td>${c.grau}</td><td>${c.inst}</td><td>${c.per√≠odo || c.per}</td><td>${c.sala}</td><td>${c.alunos}</td><td>${fmtD(c.in√≠cio || c.inicio)}</td><td>${fmtD(c.t√©rmino || c.termino)}</td>
                <td><button class="btn-icon" style="color:orange" onclick="abrirEdicao('superior',${i})"><i class="fa fa-edit"></i></button>
                <button class="btn-icon" style="color:red" onclick="removerItem('superior',${i})"><i class="fa fa-trash"></i></button></td></tr>`;
            });
        }

        function renderRegular() {
            const tb = document.getElementById('listaSalas'); tb.innerHTML = "";
            db.regular.forEach((s, i) => {
                const total = db.alunos.filter(a => a.grade === s.grade).length;
                tb.innerHTML += `<tr><td style="text-align:left"><b>${s.grade}</b></td><td>${s.tipo}</td><td>${s.per}</td><td>${s.sem}</td><td>${s.sala}</td><td>${total}</td><td>0</td><td>0</td>
                <td><button class="btn-icon" style="color:orange" onclick="abrirEdicao('regular',${i})"><i class="fa fa-edit"></i></button>
                <button class="btn-icon" style="color:red" onclick="removerItem('regular',${i})"><i class="fa fa-trash"></i></button></td></tr>`;
            });
        }

        function abrirGestaoAlunos() {
            const sel = document.getElementById('alGrade');
            sel.innerHTML = db.regular.map(s => `<option>${s.grade}</option>`).join('');
            renderAlunos();
            document.getElementById('modalGestaoAlunos').style.display = 'flex';
        }

        function renderAlunos() {
            const tb = document.getElementById('listaAlunos'); tb.innerHTML = "";
            db.alunos.forEach((a, i) => {
                tb.innerHTML += `<tr><td>${a.matricula}</td><td style="text-align:left">${a.nome}</td><td>${a.grade}</td><td>${a.serie}</td><td>${fmtD(a.inicio)}</td><td>${fmtD(a.termino)}</td>
                <td><button class="btn-icon" style="color:orange" onclick="abrirEdicao('alunos',${i})"><i class="fa fa-edit"></i></button>
                <button class="btn-icon" style="color:red" onclick="removerItem('alunos',${i})"><i class="fa fa-trash"></i></button></td></tr>`;
            });
        }

        async function salvarNovo(tipo) {
            let item = {};
            if(tipo === 'cursos') item = { nome: val('curNome').toUpperCase(), tipo: val('curTipo'), carga: val('curCarga'), inicio: val('curIni'), part: val('curPart'), termino:"", conc:"", concluido: false };
            else if(tipo === 'superior') item = { nome: val('supNome').toUpperCase(), grau: val('supGrau'), inst: val('supInst').toUpperCase(), per: val('supPer'), sala: val('supSala'), alunos: val('supAlunos'), inicio: val('supIni'), termino:"" };
            else if(tipo === 'regular') item = { grade: val('regGrade').toUpperCase(), tipo: val('regTipo'), per: val('regPer'), sem: val('regSem'), sala: val('regSala'), inicio: val('regIni'), termino: val('regFim') };
            
            db[tipo==='regular'?'regular':tipo].push(item);
            await sincronizar();
        }

        async function salvarAlunoManual() {
            const mat = val('alMat'); const nom = val('alNome');
            if(!mat || !nom) return alert("Preencha Matr√≠cula e Nome!");
            db.alunos.push({ matricula: mat, nome: nom.toUpperCase(), grade: val('alGrade'), serie: val('alSerie'), inicio: val('alIni'), termino: "" });
            await sincronizar();
            document.getElementById('alMat').value = ""; document.getElementById('alNome').value = "";
            renderAlunos();
        }

        function abrirEdicao(tipo, idx) {
            const item = (tipo==='regular'?db.regular:db[tipo])[idx];
            document.getElementById('mIdx').value = idx;
            document.getElementById('mTipo').value = tipo;
            const campos = document.getElementById('mCampos'); campos.innerHTML = "";
            
            if(tipo === 'cursos') {
                campos.innerHTML = `<label>Nome do Curso</label><input type="text" id="edNome" value="${item.nome}">
                    <label>Participantes</label><input type="number" id="edPart" value="${item.part}">
                    <label>Data In√≠cio</label><input type="date" id="edIni" value="${item.inicio}">
                    <label>Conclu√≠do?</label><select id="edConcStatus"><option value="N√ÉO" ${!item.concluido?'selected':''}>N√ÉO</option><option value="SIM" ${item.concluido?'selected':''}>SIM</option></select>
                    <label>Data T√©rmino Real</label><input type="date" id="edFim" value="${item.termino}">
                    <label>Qtd Concluintes</label><input type="number" id="edConcQtd" value="${item.conc}">`;
            } else if(tipo === 'regular') {
                campos.innerHTML = `<label>Grade (Nome da Sala)</label><input type="text" id="edGrade" value="${item.grade}">
                    <label>Tipo</label><select id="edTipo"><option ${item.tipo==='Alfabetiza√ß√£o'?'selected':''}>Alfabetiza√ß√£o</option><option ${item.tipo==='Fundamental Final'?'selected':''}>Fundamental Final</option><option ${item.tipo==='Ensino M√©dio'?'selected':''}>Ensino M√©dio</option></select>
                    <label>Per√≠odo</label><select id="edPer"><option ${item.per==='Matutino'?'selected':''}>Matutino</option><option ${item.per==='Vespertino'?'selected':''}>Vespertino</option><option ${item.per==='Noturno'?'selected':''}>Noturno</option></select>
                    <label>Semestre</label><select id="edSem"><option ${item.sem==='1¬∫ Semestre'?'selected':''}>1¬∫ Semestre</option><option ${item.sem==='2¬∫ Semestre'?'selected':''}>2¬∫ Semestre</option></select>
                    <label>Sala</label><input type="text" id="edSala" value="${item.sala}">
                    <label>In√≠cio</label><input type="date" id="edIni" value="${item.inicio}">
                    <label>T√©rmino</label><input type="date" id="edFim" value="${item.termino}">`;
            } else if(tipo === 'alunos') {
                campos.innerHTML = `<label>Nome Completo</label><input type="text" id="edNomAlu" value="${item.nome}">
                    <label>S√©rie</label><input type="text" id="edSerAlu" value="${item.serie}">
                    <label>Data In√≠cio</label><input type="date" id="edIniAlu" value="${item.inicio}">
                    <label>Data T√©rmino (Desligamento)</label><input type="date" id="edFimAlu" value="${item.termino}">`;
            }

            document.getElementById('modalGeral').style.display = 'flex';
        }

        async function confirmarEdicao() {
            const idx = val('mIdx'); const tipo = val('mTipo');
            const lista = (tipo==='regular'?db.regular:db[tipo]);
            
            if(tipo === 'cursos') {
                const status = val('edConcStatus');
                if(status === "SIM" && (!val('edFim') || !val('edConcQtd'))) return alert("Para concluir, preencha Data de T√©rmino e Qtd Concluintes!");
                lista[idx].nome = val('edNome').toUpperCase();
                lista[idx].part = val('edPart');
                lista[idx].inicio = val('edIni');
                lista[idx].concluido = (status === "SIM");
                lista[idx].termino = val('edFim');
                lista[idx].conc = val('edConcQtd');
            } else if(tipo === 'regular') {
                lista[idx].grade = val('edGrade').toUpperCase();
                lista[idx].tipo = val('edTipo');
                lista[idx].per = val('edPer');
                lista[idx].sem = val('edSem');
                lista[idx].sala = val('edSala');
                lista[idx].inicio = val('edIni');
                lista[idx].termino = val('edFim');
            } else if(tipo === 'alunos') {
                lista[idx].nome = val('edNomAlu').toUpperCase();
                lista[idx].serie = val('edSerAlu');
                lista[idx].inicio = val('edIniAlu');
                lista[idx].termino = val('edFimAlu');
            }

            fecharModal(); await sincronizar();
        }

        async function sincronizar() {
            document.getElementById('loading').style.display = 'flex';
            const payload = { acao: 'salvarTudo', cursos: db.cursos, superior: db.superior, salas: db.regular, alunos: db.alunos };
            try {
                await fetch(URL_SCRIPT, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
                await carregarDados();
            } catch(e) { alert("Erro ao salvar dados!"); }
            document.getElementById('loading').style.display = 'none';
        }

        function filtrarAlunos() {
            const f = val('filtroAlu').toUpperCase();
            const rows = document.getElementById('listaAlunos').getElementsByTagName('tr');
            for (let r of rows) { r.style.display = r.innerText.toUpperCase().includes(f) ? "" : "none"; }
        }

        function importarExcel() {
            const txt = document.getElementById('txtExcel').value;
            const linhas = txt.split('\n');
            linhas.forEach(l => {
                const c = l.split('\t');
                if(c.length >= 4 && c[1]) db.alunos.push({ matricula: c[0].trim(), nome: c[1].trim().toUpperCase(), grade: c[2].trim().toUpperCase(), serie: c[3].trim(), inicio: "", termino: "" });
            });
            renderAlunos(); document.getElementById('txtExcel').value = "";
        }

        async function removerItem(tipo, idx) {
            if(confirm("Deseja realmente excluir?")) {
                const chave = (tipo === 'regular') ? 'regular' : tipo;
                db[chave].splice(idx, 1);
                await sincronizar();
            }
        }

        function fecharGestaoAlunos() { document.getElementById('modalGestaoAlunos').style.display='none'; renderRegular(); }
        function fecharModal() { document.getElementById('modalGeral').style.display='none'; }
        function fmtD(d) { if(!d || d === "---") return "---"; try { return d.split('T')[0].split('-').reverse().join('/'); } catch(e) { return d; } }
        function val(id) { return document.getElementById(id).value; }
    </script>
</body>
</html>
